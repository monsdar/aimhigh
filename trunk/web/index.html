<html>
    <head>
        <title>AimHigh-Test</title>
        <link type='text/css' rel='stylesheet' href='stylesheet.css'>
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/themes/base/jquery-ui.css" />
        <!-- This includes jQuery 1.9.1 from Google -->
        <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
        
        
        <!-- Include other required scripts -->
        <script type="text/javascript" src="extends.js"></script>
        <script type="text/javascript" src="md5.js"></script>
        <script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script>
        <script type="text/javascript" src="http://code.highcharts.com/themes/gray.js"></script>
    </head>
    <body>
        <div class="mainContainer">
            <div class='category'></div>
            <div class="sideContainer">
                <div class='scoreContainer'>Daily score: <span class="score">0</span></div>
                <div class='createTask'>
                    <input type="text" class="newTask" value="New Task..."/>
                    <button type="button" class="submitCreate">Create</button>
                </div>
                <div class='changeDate'>
                    <input type="text" class="selectedDate" id="dateEdit" value=""/>
                    <button type="button" class="buttonToday" id="buttonToday">Today</button>
                </div>
            </div>
        </div>
        <div class="graph" id="scoreGraph" ></div>
        
        <script type="text/javascript">
            $(document).ready(function()
            {
                //this is the interface we're using
                var aimHigh="http://aimhigh.nilsbrinkmann.com/interface.php";
                $.ajaxSetup({async:false});
                
                //get the userKey, create a new user if there is no given user
                var userKey = $.getUserKey();
                if(userKey == '')
                {
                    //The following code redirects to the new users page...
                    //Perhaps there is a better way to load the URL for a new user,
                    //but I couldn't find it...
                    var randomMd5 = md5( Math.random().toString() );
                    window.location.replace("http://aimhigh.nilsbrinkmann.com/" + randomMd5);
                }

                //setup the Datepicker
                $("#dateEdit").val( $.datepicker.formatDate('yy-mm-dd', new Date()) );
                $("#dateEdit").datepicker({ dateFormat: 'yy-mm-dd' });
                
                //call the user, it will be created if not already existing
                var postVars = {userkey: userKey, request: 'touchUser'};
                $.post(aimHigh, postVars, function(data) {
                    console.log("Touched the user, received the following response: " + data);
                });
                
                //refresh the tasks
                var tasks = $.getTasks(aimHigh, userKey);
                $('.category').showTasks(tasks, $.getCurrentDate());
                $('.score').updateScore( $('.category') );
                
                //refresh the chart
                $('.graph').drawChart(tasks);
                
                $(document).on('mouseenter', '.task', function() {
                    //animate to the new size
                    var newHeight = $(this).css('height','auto').height();
                    $(this).animate({ height: 73 }, 'fast', 'swing', function() {
                        $(this).css('height', 'auto');
                    });
                    
                    $(this).css('background-color', '#8BC48B');
                    $(this).append('<a class="editLink">Edit</a>');
                    $(this).append('<a class="deleteLink">Delete</a>');
                    
                });
                $(document).on('mouseleave', '.task', function() {
                    //animate to the new size
                    var newHeight = $(this).css('height','auto').height();
                    $(this).animate({ height: 54 }, 'fast', 'swing', function() {
                        $(this).css('height', 'auto');
                    });
                    
                    $(this).css('background-color', '#dedede');
                    $('.editLink').remove();
                    $('.deleteLink').remove();
                });
                
                $(document).on('mouseenter', '.taskText', function() {
                    $(this).toggleClass('taskTextSelected');
                });
                $(document).on('mouseleave', '.taskText', function() {
                    $(this).toggleClass('taskTextSelected');
                });
                $(document).on('click', '.taskText', function() {
                    var task = $(this).closest('.task');
                    task.toggleClass('solvedTask');
                    
                    //de/activate the task in the DB
                    var taskId = task.attr('id').split('-')[1];
                    var selectedDate = $.getCurrentDate();
                    console.log("Toggling for the following date: " + selectedDate);
                    var postVars = {userkey: userKey, request: 'toggleTask', taskid: taskId, date: selectedDate};
                    $.post(aimHigh, postVars, function(data) {
                        console.log("Toggled task #" + taskId + ", received the following response: " + data);
                    });
                    
                    //update the score
                    $('.score').updateScore( $('.category') );
                    
                    //refresh the chart
                    var tasks = $.getTasks(aimHigh, userKey);
                    $('.graph').drawChart(tasks);
                });
                
                
                $(document).on('click', '#buttonToday', function() {
                    $("#dateEdit").val( $.datepicker.formatDate('yy-mm-dd', new Date()) );
                    $("#dateEdit").trigger('change');
                });
                $(document).on('change', '#dateEdit', function() {
                    console.log("Date changed to " + $('#dateEdit').val() );
                    //refresh the tasks with the given date
                    var tasks = $.getTasks(aimHigh, userKey);
                    $('.category').showTasks(tasks, $.getCurrentDate());
                });
                
                $(document).on('mouseenter', '.editLink', function() {
                    $(this).toggleClass('linkHighlighted');
                });
                $(document).on('mouseleave', '.editLink', function() {
                    $(this).toggleClass('linkHighlighted');
                });
                $(document).on('click', '.editLink', function() {
                    var text = $(this).closest('.task').find('p');
                    var newContent = '<div class="editForm">';
                    newContent = newContent + '<input type="text" value="' + text.text() + '" />';
                    newContent = newContent + '<button type="button" class="submitEdit">Done</button>';
                    newContent = newContent + '</div>';
                    text.replaceWith(newContent);
                });
                
                $(document).on('mouseenter', '.deleteLink', function() {
                    $(this).toggleClass('linkHighlighted');
                });
                $(document).on('mouseleave', '.deleteLink', function() {
                    $(this).toggleClass('linkHighlighted');
                });
                $(document).on('click', '.deleteLink', function() {
                    var task = $(this).closest('.task');
                    
                    //send the interface that the task should be deleted
                    var taskId = task.attr('id').split('-')[1];
                    var postVars = {userkey: userKey, request: 'removeTask', taskid: taskId};
                    $.post(aimHigh, postVars, function(data) {
                        console.log("Removed task #" + taskId + ", received the following response: " + data);
                    });
                                        
                    //remove the task visually
                    task.fadeTo('fast', 0, function() {
                        task.slideUp();
                    });
                    
                    //refresh the chart
                    var tasks = $.getTasks(aimHigh, userKey);
                    $('.graph').drawChart(tasks);
                });
                
                $(document).on('click', '.submitEdit', function() {
                    var editForm = $(this).closest('.editForm');
                    var input = editForm.find('input');
                    
                    //send the interface that the task should be updated
                    var task = $(this).closest('.task');
                    var taskId = task.attr('id').split('-')[1];
                    var postVars = {userkey: userKey, request: 'updateTask', taskid: taskId, text: input.val()};
                    $.post(aimHigh, postVars, function(data) {
                        console.log("Edited Task #" + taskId + ", received the following response: " + data);
                    });
                    
                    //replace the input-form with the new task-content
                    var newContent = '<p><a class="taskText">' + input.val() + '</a></p>';
                    editForm.replaceWith(newContent);
                });
                
                $(document).on('click', '.newTask', function() {
                    $(this).val('');
                });
                $(document).on('keypress', '.newTask', function(e) {
                    var code = (e.keyCode ? e.keyCode : e.which);
                    if(code == 13) { //<Enter> keycode
                        $('.submitEdit').trigger('click');
                    }
                });
                
                $(document).on('click', '.submitCreate', function() {
                    var createDiv = $(this).closest('.createTask');
                    var input = createDiv.find('input');
                    var text = input.val();
                                        
                    //create the task, refresh them afterwards
                    $('').createTask(aimHigh, userKey, text);
                    var tasks = $.getTasks(aimHigh, userKey);
                    $('.category').showTasks(tasks, $.getCurrentDate());
                    
                    //reset the inputs value
                    input.val('New Task...');
                });
            });
                
	</script>
    </body>
</html>
