<html>
    <head>
        <title>AimHigh-Test</title>
        <link type='text/css' rel='stylesheet' href='stylesheet.css'>
        <!-- This includes jQuery 1.9.0 from Google -->
        <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <!-- Include other required scripts -->
        <script type="text/javascript" src="extends.js"></script>
        <script type="text/javascript" src="md5.js"></script>
    </head>
    <body>
        <div class='createTask'>
            <input type="text" class="newTask" value="New Task..."/>
            <button type="button" class="submitCreate">Create</button>
        </div>
        <div class='category'>
        </div>
        <script type="text/javascript">
            $(document).ready(function()
            {
                //this is the interface we're using
                var aimHigh="http://aimhigh.nilsbrinkmann.com/interface.php";
                $.ajaxSetup({async:false});
                
                //get the userKey, create a new user if there is no given user
                var userKey = $.getUserKey();
                if(userKey == '')
                {
                    //TODO: Update the page with a random username
                    console.log(md5( Math.random().toString() ));
                    userKey = "TestUser"; //Currently we're using TestUser here
                }
                
                //call the user, it will be created if not already existing
                var postVars = {userkey: userKey, request: 'touchUser'};
                $.post(aimHigh, postVars, function(data) {
                    console.log("Touched the user, received the following response: " + data);
                });
                
                //refresh the tasks
                $('.category').refreshTasks(aimHigh, userKey);
                
                $(document).on('mouseenter', '.task', function() {
                    //animate to the new size
                    var newHeight = $(this).css('height','auto').height();
                    $(this).animate({ height: 73 }, 'fast', 'swing', function() {
                        $(this).css('height', 'auto');
                    });
                    
                    $(this).css('background-color', '#8BC48B');
                    $(this).append('<span class="editLink">Edit</span>');
                    $(this).append('<span class="deleteLink">Delete</span>');
                    
                });
                $(document).on('mouseleave', '.task', function() {
                    //animate to the new size
                    var newHeight = $(this).css('height','auto').height();
                    $(this).animate({ height: 54 }, 'fast', 'swing', function() {
                        $(this).css('height', 'auto');
                    });
                    
                    $(this).css('background-color', '#dedede');
                    $('.editLink').remove();
                    $('.deleteLink').remove();
                });
                $(document).on('click', '.task', function() {
                    $(this).toggleClass('solvedTask');
                });
                
                $(document).on('mouseenter', '.editLink', function() {
                    $(this).toggleClass('linkHighlighted');
                });
                $(document).on('mouseleave', '.editLink', function() {
                    $(this).toggleClass('linkHighlighted');
                });
                $(document).on('click', '.editLink', function() {
                    var text = $(this).closest('.task').find('p');
                    var newContent = '<div class="editForm">';
                    newContent = newContent + '<input type="text" value="' + text.text() + '" />';
                    newContent = newContent + '<button type="button" class="submitEdit">Done</button>';
                    newContent = newContent + '</div>';
                    text.replaceWith(newContent);
                });
                
                $(document).on('mouseenter', '.deleteLink', function() {
                    $(this).toggleClass('linkHighlighted');
                });
                $(document).on('mouseleave', '.deleteLink', function() {
                    $(this).toggleClass('linkHighlighted');
                });
                $(document).on('click', '.deleteLink', function() {
                    var task = $(this).closest('.task');
                    
                    //send the interface that the task should be deleted
                    var taskId = task.attr('id').split('-')[1];
                    var postVars = {userkey: userKey, request: 'removeTask', taskid: taskId};
                    $.post(aimHigh, postVars, function(data) {
                        console.log("Removed task #" + taskId + ", received the following response: " + data);
                    });
                                        
                    //remove the task visually
                    task.fadeTo('fast', 0, function() {
                        task.slideUp();
                    });
                });
                
                $(document).on('click', '.submitEdit', function() {
                    var editForm = $(this).closest('.editForm');
                    var input = editForm.find('input');
                    
                    //send the interface that the task should be updated
                    var task = $(this).closest('.task');
                    var taskId = task.attr('id').split('-')[1];
                    var postVars = {userkey: userKey, request: 'updateTask', taskid: taskId, text: input.val()};
                    $.post(aimHigh, postVars, function(data) {
                        console.log("Edited Task #" + taskId + ", received the following response: " + data);
                    });
                    
                    //replace the input-form with the new task-content
                    var newContent = '<p>' + input.val() + '</p>';
                    editForm.replaceWith(newContent);
                });
                
                $(document).on('click', '.submitCreate', function() {
                    var createDiv = $(this).closest('.createTask');
                    var input = createDiv.find('input');
                    
                    //send the interface that the task should be created
                    var postVars = {userkey: userKey, request: 'createTask', text: input.val()};
                    $.post(aimHigh, postVars, function(data) {
                        console.log("Created new task, received the following response: ");
                        console.log(data);
                    });
                    
                    //refresh the tasks
                    $('.category').refreshTasks(aimHigh, userKey);
                    
                    //reset the inputs value
                    input.val('New Task...');
                });
            });
                
	</script>
    </body>
</html>
